import numpy as np

def unified_id_to_str(unified_id_val):
    # 统一转成稳定字符串，list/tuple/set 都能处理
    if isinstance(unified_id_val, (list, tuple, set)):
        try:
            items = sorted(unified_id_val)          # set 无序，排序保证稳定
        except TypeError:
            items = sorted(map(str, unified_id_val)) # 混合类型时兜底
        return "_".join(map(str, items))
    return str(unified_id_val)

flow_segments = []

mapping_txt_path = "flowsegment_name_map.txt"
with open(mapping_txt_path, "w", encoding="utf-8") as f_map:
    f_map.write("# ifc_name\tunified_id(block)\n")

    for idx, cylinder in enumerate(cylinders):
        start = cylinder['start']
        end = cylinder['end']
        radius = cylinder['radius']

        if np.linalg.norm(np.subtract(end, start)) == 0:
            continue

        if 'unified_id' not in cylinder:
            print(f"Warning: Missing unified_id in {cylinder}")
            continue

        unified_id_str = unified_id_to_str(cylinder['unified_id'])

        # 你的原命名方式：不做 0000
        original_name = cylinder.get('name', "FlowSegment")
        new_name = f"{original_name}_{idx}"
        print(f"Generated name: {new_name}")

        # 只写 txt 映射
        f_map.write(f"{new_name}\t{unified_id_str}\n")

        # ---- 下面你的 IFC 创建逻辑照旧 ----
        flow_segment = ifc_file.create_entity(
            'IfcFlowSegment',
            GlobalId=ifcopenshell.guid.new(),
            OwnerHistory=owner_history,
            Name=new_name,
            ObjectPlacement=ifc_file.createIfcLocalPlacement(storey_placement, axis_placement)
        )

        cylinder_geometry = create_cylinder_geometry(ifc_file, start, end, radius, context)
        flow_segment.Representation = ifc_file.create_entity(
            'IfcProductDefinitionShape',
            Representations=[cylinder_geometry]
        )

        pset = ifcopenshell.api.run(
            "pset.add_pset",
            ifc_file,
            product=flow_segment,
            name="Property"
        )

        length = get_length(cylinder)
        confidence = cylinder.get('confidence', cylinder.get('coverage', 1.))

        properties = {
            'length': (f"{length:.3f}", "IfcLengthMeasure"),
            'StartPoint': (f"({start[0]:.3f}, {start[1]:.3f}, {start[2]:.3f})", "IfcLabel"),
            'EndPoint': (f"({end[0]:.3f}, {end[1]:.3f}, {end[2]:.3f})", "IfcLabel"),
            'Radius': (f"{radius:.3f}", "IfcLengthMeasure"),
            'Diameter': (f"{radius * 2:.3f}", "IfcLengthMeasure"),
            'Confidence': (f"{confidence:.3f}", "IfcNormalisedRatioMeasure"),
        }

        ifcopenshell.api.pset.edit_pset(
            ifc_file,
            pset,
            properties={k: v[0] for k, v in properties.items()}
        )

        flow_segments.append(flow_segment)

print("Saved mapping txt:", mapping_txt_path)
