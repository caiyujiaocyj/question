
import numpy as np
import os
from plyfile import PlyData, PlyElement


def npz_to_ply(npz_path, ply_path, key="surf"):
    """
    将 npz 文件中的指定数组转换为 ply 点云文件。
    默认使用 key='surf'，也可以改成 'centerline'。

    :param npz_path: 输入的 npz 文件路径
    :param ply_path: 输出的 ply 文件路径
    :param key:      npz 中要导出的数组名（例如 'surf' 或 'centerline'）
    """
    # 加载 npz
    data = np.load(npz_path)

    if key not in data:
        raise KeyError(f"{npz_path} 中未找到键 '{key}'，可用键有: {list(data.keys())}")

    pts = data[key]

    # 只取前 3 维作为 xyz
    if pts.ndim != 2 or pts.shape[1] < 3:
        raise ValueError(f"{npz_path}['{key}'] 形状必须是 (N, >=3)，当前为 {pts.shape}")

    xyz = pts[:, :3].astype(np.float32)

    # 创建 ply 顶点数据
    vertex = np.array([tuple(p) for p in xyz],
                      dtype=[('x', 'f4'), ('y', 'f4'), ('z', 'f4')])

    el = PlyElement.describe(vertex, 'vertex')
    PlyData([el]).write(ply_path)
    # print(f"Converted {npz_path} -> {ply_path} (key='{key}')")


def process_directory(input_base_dir, output_base_dir, key="surf"):
    """
    处理 input_base_dir 目录下所有以 block_1Ftest_ 开头的子目录，
    将其中的 .npz 转成 .ply（同名，换后缀），目录结构保持不变。

    :param input_base_dir:  输入基础目录路径（里面有很多 block_1Ftest_* 子目录）
    :param output_base_dir: 输出基础目录路径
    :param key:             npz 中要导出的数组名（'surf' 或 'centerline'）
    """
    for dir_name in os.listdir(input_base_dir):
        if dir_name.startswith("block_1Ftest_"):
            input_dir_path = os.path.join(input_base_dir, dir_name)
            if not os.path.isdir(input_dir_path):
                continue

            output_dir_path = os.path.join(output_base_dir, dir_name)
            os.makedirs(output_dir_path, exist_ok=True)

            # 遍历该 block 下所有 npz 文件
            for file_name in os.listdir(input_dir_path):
                if file_name.endswith(".npz"):
                    input_npz_path = os.path.join(input_dir_path, file_name)
                    output_ply_name = os.path.splitext(file_name)[0] + ".ply"
                    output_ply_path = os.path.join(output_dir_path, output_ply_name)

                    try:
                        npz_to_ply(input_npz_path, output_ply_path, key=key)
                    except Exception as e:
                        print(f"Error processing {input_npz_path}: {e}")


if __name__ == "__main__":
    # 和你原来一样的输入目录，只是现在里面是 npz
    input_base_dir = r"/media/samsung/samsung/mc.wei/code/fitting_latest/exp/NRDK/baseline_s2/cascade_result_seg_baseline_s1/cylinder_fitting_wo_merge__11_21_18_44/save_for_cluster"

    # 输出目录你可以随便取一个新的
    output_base_dir = r"/media/samsung/samsung/mc.wei/code/fitting_latest/exp/NRDK/baseline_s2/cascade_result_seg_baseline_s1/cylinder_fitting_wo_merge__11_21_18_44/save_for_cluster_ply_npz"

    # 检查输入目录
    if not os.path.exists(input_base_dir):
        print(f"Error: Input directory {input_base_dir} does not exist")
        raise SystemExit(1)

    os.makedirs(output_base_dir, exist_ok=True)

    # key="surf" 表示导出每个 cluster 的表面点；
    # 如果想看拟合候选中心线点云，改成 key="centerline" 即可
    process_directory(input_base_dir, output_base_dir, key="surf")

    print("Conversion completed!")