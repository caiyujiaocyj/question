import pickle
from typing import Any, List, Dict, Union
import json

def load_pkl(fname: str) -> Any:
    """加载 pickle 文件"""
    with open(fname, "rb") as f:
        return pickle.load(f)

def analyze_cyn_data(cyn_data: Union[List[Dict[str, Any]], Dict[str, Any]]) -> List[Dict[str, Any]]:
    """
    分析圆柱体数据，统计每个半径的信息

    参数:
        cyn_data: 可以是单个圆柱体字典，或圆柱体字典列表

    返回:
        包含统计结果的字典列表，每个字典包含 radius、length 和 count
    """
    stats = {}

    # 统一处理：如果是单个字典，转为列表
    if isinstance(cyn_data, dict):
        cyn_list = [cyn_data]
    elif isinstance(cyn_data, list):
        cyn_list = cyn_data
    else:
        raise ValueError("输入必须是字典或字典列表")

    for cyn in cyn_list:
        # 如果是字符串（如JSON），尝试解析为字典
        if isinstance(cyn, str):
            try:
                cyn = json.loads(cyn)
            except json.JSONDecodeError:
                continue  # 跳过无效JSON

        # 确保是字典且包含必要字段
        if not isinstance(cyn, dict):
            continue

        try:
            radius = cyn["radius"]
            length = cyn["length"]
        except KeyError:
            continue  # 跳过缺少字段的数据

        # 更新统计信息
        if radius in stats:
            stats[radius]["length"] += length
            stats[radius]["count"] += 1
        else:
            stats[radius] = {"radius": radius, "length": length, "count": 1}

    return list(stats.values())

def main():
    fname_gt = "D:\\cyj\\P&D_15L_ABC_seg1.0.pkl"
    all_cyls = load_pkl(fname_gt)

    # 假设 all_cyls 是列表，每个元素是字典（包含 "extend_inf" 键）
    for cyl in all_cyls:
        extend_inf_data = cyl["extend_inf"]

        # 分析数据（兼容单个字典或列表）
        analysis_result = analyze_cyn_data(extend_inf_data)

        # 打印结果
        for item in analysis_result:
            print(f"半径: {item['radius']:.4f}, 总长度: {item['length']:.4f}, 数量: {item['count']}")

if __name__ == "__main__":
    main()
